<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>rOPTRAM: Deriving Soil Moisture from Sentinel-2 Imagery • rOPTRAM</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="rOPTRAM: Deriving Soil Moisture from Sentinel-2 Imagery">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">rOPTRAM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.3.0.000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="active nav-item"><a class="nav-link" href="../articles/rOPTRAM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/rOPTRAM_acquiring.html">Acquiring Sentinel-2 Imagery</a></li>
    <li><a class="dropdown-item" href="../articles/rOPTRAM_trapezoid_methods.html">rOPTRAM: Three Trapezoid Fitting Methods</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/rOPTRAM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>rOPTRAM: Deriving Soil Moisture from Sentinel-2 Imagery</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rOPTRAM/blob/master/vignettes/rOPTRAM.Rmd" class="external-link"><code>vignettes/rOPTRAM.Rmd</code></a></small>
      <div class="d-none name"><code>rOPTRAM.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction
<img align="right" width="100" height="100" src="images/rOPTRAM_logo.jpg"><a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>rOPTRAM</code> implements The OPtical TRapezoid Model (OPTRAM)
to derive soil moisture based on the linear relation between a
vegetation index, i.e. NDVI, and Land Surface Temperature (LST). The
Short Wave Infra-red (SWIR) band is used as a proxy for LST. The SWIR
band is transformed to Swir Transformed Reflectance (STR).</p>
<p>A scatterplot of NDVI vs. STR is used to produce wet and dry linear
regression lines, and the slope/intercept coefficients of these lines
comprise the trapezoid. These coefficients are then used on a new
satellite image to determine soil moisture.</p>
<p>See: <span class="citation">Sadeghi et al. (2017)</span>, <span class="citation">Burdun et al. (2020)</span>, <span class="citation">Ambrosone et al. (2020)</span></p>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>Only a small number of commonly used R packages are required to use
{rOPTRAM}. This includes:</p>
<ul>
<li>base packages {tools} and {utils}</li>
<li>spatial packages {sf} and {terra}</li>
<li>data.frame and plotting {dplyr}, {ggplot2}</li>
</ul>
<p>Also, to allow {rOPTRAM} to download Sentinel-2 images, clip to a
study area, and prepare the necessary vegetation index and STR products,
the R package {CDSE} (see <span class="citation">Karaman (2023)</span>)
as well as {jsonlite} are required.</p>
</div>
</div>
<div class="section level2">
<h2 id="workflows">Workflows<a class="anchor" aria-label="anchor" href="#workflows"></a>
</h2>
<p>Users can download Sentinel-2 tiles from the Copernicus manually, and
run thru the steps one by one to produce the OPTRAM trapezoid, and
predicted soil moisture maps. However, this approach is not optimal. The
complete workflow can be initiated with a single function call to
download, clip to area of interest, and produce the trapezoid
coefficients. This all-inclusive approach is highly recommended since
processing of the Sentinel-2 data is performed “in the cloud” and only
the final products are downloaded, <strong>greatly</strong> reducing the
download file sizes.</p>
<p>That recommended R package {CDSE} interfaces with the Copernicus
DataSpace Ecosystem in one of two ways:</p>
<ul>
<li>Thru the <a href="https://shapps.dataspace.copernicus.eu/dashboard/#/" class="external-link">Scihub
API</a>.</li>
<li>Thru the <a href="https://openeo.dataspace.copernicus.eu/" class="external-link">openEO
platform</a>
</li>
</ul>
<p>Both methods require <a href="https://dataspace.copernicus.eu/" class="external-link">registering</a> on the
Copernicus DataSpace</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ropensci/rOPTRAM"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rOPTRAM">rOPTRAM</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">'rOPTRAM'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The {CDSE} and {jsonlite} packages are required for downloading Sentinel imagery from Copernicus DataSpace.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://zivankaraman.github.io/CDSE/" class="external-link">"CDSE"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://jeroen.r-universe.dev/jsonlite" class="external-link">"jsonlite"</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="package-options">Package options<a class="anchor" aria-label="anchor" href="#package-options"></a>
</h2>
<p>The {rOPTRAM} package is controlled by several options, set
automatically when the package first loads. These defaults can be viewed
by running the function <code><a href="../reference/optram_options.html">optram_options()</a></code> without
arguments:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "edge_points = TRUE"</span></span>
<span><span class="co">#&gt; [1] "feature_col = ID"</span></span>
<span><span class="co">#&gt; [1] "max_cloud = 12"</span></span>
<span><span class="co">#&gt; [1] "max_tbl_size = 1e+06"</span></span>
<span><span class="co">#&gt; [1] "period = seasonal"</span></span>
<span><span class="co">#&gt; [1] "plot_colors = colors"</span></span>
<span><span class="co">#&gt; [1] "remote = scihub"</span></span>
<span><span class="co">#&gt; [1] "rm.hi.str = FALSE"</span></span>
<span><span class="co">#&gt; [1] "rm.low.vi = FALSE"</span></span>
<span><span class="co">#&gt; [1] "SWIR_band = 11"</span></span>
<span><span class="co">#&gt; [1] "trapezoid_method = linear"</span></span>
<span><span class="co">#&gt; [1] "veg_index = NDVI"</span></span>
<span><span class="co">#&gt; [1] "vi_step = 0.005"</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Users can override any of the defaults by calling this function with
alternative values for the options. For example, Sentinel images are
downloaded, by default for all available image dates between the
specified <code>from_date</code> and <code>to_date</code>. Users can,
instead, choose to download images only for a specific season as
follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="st">"period"</span>, <span class="st">"seasonal"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "edge_points = TRUE"</span></span>
<span><span class="co">#&gt; [1] "feature_col = ID"</span></span>
<span><span class="co">#&gt; [1] "max_cloud = 12"</span></span>
<span><span class="co">#&gt; [1] "max_tbl_size = 1e+06"</span></span>
<span><span class="co">#&gt; [1] "period = seasonal"</span></span>
<span><span class="co">#&gt; [1] "plot_colors = colors"</span></span>
<span><span class="co">#&gt; [1] "remote = scihub"</span></span>
<span><span class="co">#&gt; [1] "rm.hi.str = FALSE"</span></span>
<span><span class="co">#&gt; [1] "rm.low.vi = FALSE"</span></span>
<span><span class="co">#&gt; [1] "SWIR_band = 11"</span></span>
<span><span class="co">#&gt; [1] "trapezoid_method = linear"</span></span>
<span><span class="co">#&gt; [1] "veg_index = NDVI"</span></span>
<span><span class="co">#&gt; [1] "vi_step = 0.005"</span></span></code></pre></div>
<p>Now, only images between the day/month of <code>from_date</code> and
day/month of <code>to_date</code> will be acquired, but for all years in
the date range.</p>
<p>Three trapezoid fitting functions are implemented in {rOPTRAM}. The
default is “linear”, but users can change as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="st">"trapezoid_method"</span>, <span class="st">"polynomial"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "edge_points = TRUE"</span></span>
<span><span class="co">#&gt; [1] "feature_col = ID"</span></span>
<span><span class="co">#&gt; [1] "max_cloud = 12"</span></span>
<span><span class="co">#&gt; [1] "max_tbl_size = 1e+06"</span></span>
<span><span class="co">#&gt; [1] "period = seasonal"</span></span>
<span><span class="co">#&gt; [1] "plot_colors = colors"</span></span>
<span><span class="co">#&gt; [1] "remote = scihub"</span></span>
<span><span class="co">#&gt; [1] "rm.hi.str = FALSE"</span></span>
<span><span class="co">#&gt; [1] "rm.low.vi = FALSE"</span></span>
<span><span class="co">#&gt; [1] "SWIR_band = 11"</span></span>
<span><span class="co">#&gt; [1] "trapezoid_method = polynomial"</span></span>
<span><span class="co">#&gt; [1] "veg_index = NDVI"</span></span>
<span><span class="co">#&gt; [1] "vi_step = 0.005"</span></span></code></pre></div>
<p>The default trapezoid plot shows a scatter plot cloud of vegetation
index values vs SWIR Transformed Reflectance, where all points have a
uniform color. This plot can be improved by coloring the points by their
density within the scatterplot. This is accomplished by choosing to set
the option “plot_colors” to “colors”:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="st">"plot_colors"</span>, <span class="st">"colors"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "edge_points = TRUE"</span></span>
<span><span class="co">#&gt; [1] "feature_col = ID"</span></span>
<span><span class="co">#&gt; [1] "max_cloud = 12"</span></span>
<span><span class="co">#&gt; [1] "max_tbl_size = 1e+06"</span></span>
<span><span class="co">#&gt; [1] "period = seasonal"</span></span>
<span><span class="co">#&gt; [1] "plot_colors = colors"</span></span>
<span><span class="co">#&gt; [1] "remote = scihub"</span></span>
<span><span class="co">#&gt; [1] "rm.hi.str = FALSE"</span></span>
<span><span class="co">#&gt; [1] "rm.low.vi = FALSE"</span></span>
<span><span class="co">#&gt; [1] "SWIR_band = 11"</span></span>
<span><span class="co">#&gt; [1] "trapezoid_method = polynomial"</span></span>
<span><span class="co">#&gt; [1] "veg_index = NDVI"</span></span>
<span><span class="co">#&gt; [1] "vi_step = 0.005"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="main-wrapper-function">Main wrapper function<a class="anchor" aria-label="anchor" href="#main-wrapper-function"></a>
</h2>
<div class="section level3">
<h3 id="run-the-full-optram-model-procedure-with-a-single-function-call">Run the full OPTRAM model procedure with a single function call<a class="anchor" aria-label="anchor" href="#run-the-full-optram-model-procedure-with-a-single-function-call"></a>
</h3>
<p>Registration on Copernicus DataSpace was done in advance, and the
OAuth credentials (<em>clientid</em>, and <em>secret</em>) have been
saved to the user’s home directory.</p>
<p>Downloaded Sentinel-2 images are saved to <code>S2_output_dir</code>.
For this example, outputs are saved to <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">from_date</span> <span class="op">&lt;-</span> <span class="st">"2022-05-01"</span></span>
<span><span class="va">to_date</span> <span class="op">&lt;-</span> <span class="st">"2023-04-30"</span></span>
<span><span class="va">output_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">aoi</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                               <span class="st">"lachish.gpkg"</span>, package <span class="op">=</span> <span class="st">"rOPTRAM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="st">"veg_index"</span>, <span class="st">"NDVI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/optram_options.html">optram_options</a></span><span class="op">(</span><span class="st">"trapezoid_method"</span>, <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optram.html">optram</a></span><span class="op">(</span><span class="va">aoi</span>,</span>
<span>              <span class="va">from_date</span>, <span class="va">to_date</span>,</span>
<span>              S2_output_dir <span class="op">=</span> <span class="va">output_dir</span>,</span>
<span>              data_output_dir <span class="op">=</span> <span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "RMSE for fitted trapezoid:"</span></span>
<span><span class="co">#&gt;    RMSE.wet  RMSE.dry</span></span>
<span><span class="co">#&gt; 1 0.2747341 0.1407656</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">rmse</span>, caption <span class="op">=</span> <span class="st">"Trapezoid coefficients"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Trapezoid coefficients</caption>
<thead><tr class="header">
<th align="right">RMSE.wet</th>
<th align="right">RMSE.dry</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.2747341</td>
<td align="right">0.1407656</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="show-trapezoid-plot">Show trapezoid plot<a class="anchor" aria-label="anchor" href="#show-trapezoid-plot"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edges_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"trapezoid_edges_lin.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"VI_STR_data.rds"</span><span class="op">)</span></span>
<span><span class="va">full_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">df_file</span><span class="op">)</span></span>
<span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_vi_str_cloud.html">plot_vi_str_cloud</a></span><span class="op">(</span><span class="va">full_df</span>, <span class="va">edges_df</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/plot-prepare-1.png" alt="plot of chunk plot-prepare"><div class="figcaption">plot of chunk plot-prepare</div>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">pl</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Lachish area trapezoid plot"</span>,</span>
<span>                            subtitle <span class="op">=</span> <span class="st">"linear fitted"</span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"trapezoid_lachish_linear.png"</span><span class="op">)</span>,</span>
<span>                width <span class="op">=</span> <span class="fl">18</span>, height <span class="op">=</span> <span class="fl">12</span>, units <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"images/trapezoid_lachish_linear.png"</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="images/trapezoid_lachish_linear.png" alt="plot of chunk plot-trap"><div class="figcaption">plot of chunk plot-trap</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="step-by-step">Step by step<a class="anchor" aria-label="anchor" href="#step-by-step"></a>
</h2>
<div class="section level3">
<h3 id="the-same-procedure-as-the-wrapper-function-but-in-explicit-steps">The same procedure as the wrapper function, but in explicit
steps<a class="anchor" aria-label="anchor" href="#the-same-procedure-as-the-wrapper-function-but-in-explicit-steps"></a>
</h3>
<ul>
<li>Acquire Sentinel 2 images within a date range, and crop to AOI;</li>
<li>Prepare the SWIR Transformed Reflectance;</li>
<li>Prepare a data.frame of Vegetation Index and STR values;</li>
<li>Activate the options to remove VI values below zero</li>
<li>and the option to remove outlier STR values</li>
<li>Get trapezoid coefficients from the scatterplot of VI-STR
pixels</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using the same dates, and aoi as previous example</span></span>
<span><span class="va">s2_file_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optram_acquire_s2.html">optram_acquire_s2</a></span><span class="op">(</span><span class="va">aoi</span>,</span>
<span>                            <span class="va">from_date</span>, <span class="va">to_date</span>,</span>
<span>                            output_dir <span class="op">=</span> <span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="va">STR_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"STR"</span><span class="op">)</span>,</span>
<span>                      pattern <span class="op">=</span> <span class="st">".tif$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">VI_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"NDVI"</span><span class="op">)</span>,</span>
<span>                      pattern <span class="op">=</span> <span class="st">".tif$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">full_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optram_ndvi_str.html">optram_ndvi_str</a></span><span class="op">(</span><span class="va">STR_list</span>, <span class="va">VI_list</span>,</span>
<span>                           output_dir <span class="op">=</span> <span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optram_wetdry_coefficients.html">optram_wetdry_coefficients</a></span><span class="op">(</span><span class="va">full_df</span>,</span>
<span>                                   output_dir <span class="op">=</span> <span class="va">output_dir</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">rmse</span>, caption <span class="op">=</span> <span class="st">"RMSE of fitted trapezoid edges"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>RMSE of fitted trapezoid edges</caption>
<thead><tr class="header">
<th align="right">RMSE.wet</th>
<th align="right">RMSE.dry</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.2823248</td>
<td align="right">0.1338994</td>
</tr></tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="soil-moisture-estimate">Soil Moisture Estimate<a class="anchor" aria-label="anchor" href="#soil-moisture-estimate"></a>
</h2>
<div class="section level3">
<h3 id="use-trapezoid-coefficients-vi-and-str-rasters-to-derive-soil-moisture-grid">Use trapezoid coefficients, VI, and STR rasters to derive soil
moisture grid<a class="anchor" aria-label="anchor" href="#use-trapezoid-coefficients-vi-and-str-rasters-to-derive-soil-moisture-grid"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">img_date</span> <span class="op">&lt;-</span> <span class="st">"2023-01-10"</span>   <span class="co"># After a rain</span></span>
<span><span class="va">VI_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"NDVI"</span><span class="op">)</span></span>
<span><span class="va">STR_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="st">"STR"</span><span class="op">)</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="va">output_dir</span></span>
<span><span class="va">SM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optram_calculate_soil_moisture.html">optram_calculate_soil_moisture</a></span><span class="op">(</span><span class="va">img_date</span>, <span class="va">VI_dir</span>, <span class="va">STR_dir</span>,</span>
<span>                                     data_dir <span class="op">=</span> <span class="va">data_dir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="soil-moisture-plot">Soil moisture plot<a class="anchor" aria-label="anchor" href="#soil-moisture-plot"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">"viridis"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://rspatial.org/" class="external-link">"terra"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">SM</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Lachish soil moisture"</span></span>
<span><span class="va">SM</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">SM</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">SM</span>, col <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu">viridis</span><span class="fu">::</span><span class="fu">viridis</span><span class="op">(</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span>, smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            main <span class="op">=</span> <span class="st">"Soil moisture map"</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/sm-plot-1.png" alt="plot of chunk sm-plot"><div class="figcaption">plot of chunk sm-plot</div>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"images/sm-plot.png"</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="images/sm-plot.png" alt="plot of chunk sm-plot-1"><div class="figcaption">plot of chunk sm-plot-1</div>
</div>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-ambrosone_retrieving_2020" class="csl-entry">
Ambrosone, Mariapaola, Alessandro Matese, Salvatore Filippo Di Gennaro,
Beniamino Gioli, Marin Tudoroiu, Lorenzo Genesio, Franco Miglietta, et
al. 2020. <span>“Retrieving Soil Moisture in Rainfed and Irrigated
Fields Using <span>Sentinel</span>-2 Observations and a Modified
<span>OPTRAM</span> Approach.”</span> <em>International Journal of
Applied Earth Observation and Geoinformation</em> 89 (July): 102113. <a href="https://doi.org/10.1016/j.jag.2020.102113" class="external-link">https://doi.org/10.1016/j.jag.2020.102113</a>.
</div>
<div id="ref-burdun_satellite_2020" class="csl-entry">
Burdun, Iuliia, Michel Bechtold, Valentina Sagris, Annalea Lohila, Elyn
Humphreys, Ankur R. Desai, Mats B. Nilsson, Gabrielle De Lannoy, and Ülo
Mander. 2020. <span>“Satellite <span>Determination</span> of
<span>Peatland</span> <span>Water</span> <span>Table</span>
<span>Temporal</span> <span>Dynamics</span> by <span>Localizing</span>
<span>Representative</span> <span>Pixels</span> of <span>A</span>
<span>SWIR</span>-<span>Based</span> <span>Moisture</span>
<span>Index</span>.”</span> <em>Remote Sensing</em> 12 (18): 2936. <a href="https://doi.org/10.3390/rs12182936" class="external-link">https://doi.org/10.3390/rs12182936</a>.
</div>
<div id="ref-karaman_cdse_2023" class="csl-entry">
Karaman, Zivan. 2023. <span>“CDSE: Copernicus Data Space Ecosystem API
Wrapper.”</span> <a href="https://CRAN.R-project.org/package=CDSE" class="external-link">https://CRAN.R-project.org/package=CDSE</a>.
</div>
<div id="ref-sadeghi_optical_2017" class="csl-entry">
Sadeghi, Morteza, Ebrahim Babaeian, Markus Tuller, and Scott B. Jones.
2017. <span>“The Optical Trapezoid Model: <span>A</span> Novel Approach
to Remote Sensing of Soil Moisture Applied to <span>Sentinel</span>-2
and <span>Landsat</span>-8 Observations.”</span> <em>Remote Sensing of
Environment</em> 198 (September): 52–68. <a href="https://doi.org/10.1016/j.rse.2017.05.041" class="external-link">https://doi.org/10.1016/j.rse.2017.05.041</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
